{% extends 'base.html' %}
{% load static %}

{% block title %}Checkout{% endblock %}

{% block content %}
<div class="container py-5">
    <form method="POST" id="checkoutForm">
        {% csrf_token %}
        
        <div class="row">
            <!-- Left Column - Address and Payment -->
            <div class="col-md-6">
                <!-- Shipping Address -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Shipping Address</h5>
                    </div>
                    <div class="card-body">
                        {% if addresses %}
                        <div class="row">
                            {% for address in addresses %}
                            <div class="col-12 mb-3">
                                <div class="card h-100">
                                    <div class="card-body">
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="address_id" 
                                                   id="address_{{ address.id }}" value="{{ address.id }}"
                                                   {% if forloop.first %}checked{% endif %} required>
                                            <label class="form-check-label" for="address_{{ address.id }}">
                                                {{ address.get_full_address }}
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        {% else %}
                        <p>No addresses found. Please add an address.</p>
                        <a href="{% url 'add_address' %}" class="btn btn-primary">Add Address</a>
                        {% endif %}
                    </div>
                </div>

                <!-- Payment Methods -->
                <div class="card shadow-sm mb-4">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Payment Method</h5>
                    </div>
                    <div class="card-body">
                        {% for value, label in form.payment_method.field.choices %}
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="radio" name="{{ form.payment_method.name }}" 
                                   id="payment_{{ value }}" value="{{ value }}"
                                   {% if forloop.first %}checked{% endif %}>
                            <label class="form-check-label" for="payment_{{ value }}">{{ label }}</label>
                        </div>
                        {% endfor %}

                        <!-- Card payment details -->
                        <div id="cardDetails" style="display: none;">
                            <div class="mb-3">
                                <label class="form-label">Card Number</label>
                                <input type="text" class="form-control" name="card_number" placeholder="1234 5678 9012 3456">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Expiry Date</label>
                                <input type="text" class="form-control" name="expiry_date" placeholder="MM/YY">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">CVV</label>
                                <input type="text" class="form-control" name="cvv" placeholder="123">
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Name on Card</label>
                                <input type="text" class="form-control" name="card_name" placeholder="John Doe">
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="col-md-6">
                <div class="card shadow-sm">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0">Order Summary</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th>Quantity</th>
                                        <th class="text-end">Price</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in cart_items %}
                                    <tr>
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <img src="{{ item.product.image.url }}" alt="{{ item.product.title }}" 
                                                     class="img-thumbnail me-2" style="width: 50px; height: 50px; object-fit: cover;">
                                                <span>{{ item.product.title }}</span>
                                            </div>
                                        </td>
                                        <td>{{ item.quantity }}</td>
                                        <td class="text-end">₹{{ item.get_total_price }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="2" class="text-end">Total:</th>
                                        <th class="text-end">₹{{ total }}</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                        <button type="submit" class="btn btn-primary w-100 mt-3">Place Order</button>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const checkoutForm = document.getElementById('checkoutForm');
    const cardRadio = document.getElementById('payment_card');
    const cardDetails = document.getElementById('cardDetails');

    function toggleCardDetails() {
        cardDetails.style.display = cardRadio.checked ? 'block' : 'none';
    }

    // Add event listeners to all payment method radio buttons
    document.querySelectorAll('input[name="{{ form.payment_method.name }}"]').forEach(radio => {
        radio.addEventListener('change', toggleCardDetails);
    });

    // Initial state
    toggleCardDetails();

    // Form validation
    checkoutForm.addEventListener('submit', function (e) {
        const selectedAddress = document.querySelector('input[name="address_id"]:checked');
        if (!selectedAddress) {
            e.preventDefault();
            alert('Please select a shipping address');
            return;
        }

        if (cardRadio.checked) {
            const cardNumber = document.querySelector('input[name="card_number"]').value.trim();
            const expiry = document.querySelector('input[name="expiry_date"]').value.trim();
            const cvv = document.querySelector('input[name="cvv"]').value.trim();
            const cardName = document.querySelector('input[name="card_name"]').value.trim();

            if (!/^\d{16}$/.test(cardNumber.replace(/\s/g, ''))) {
                e.preventDefault();
                alert('Please enter a valid 16-digit card number');
                return;
            }
            if (!/^\d{2}\/\d{2}$/.test(expiry)) {
                e.preventDefault();
                alert('Please enter expiry date in MM/YY format');
                return;
            }
            if (!/^\d{3}$/.test(cvv)) {
                e.preventDefault();
                alert('Please enter a valid 3-digit CVV');
                return;
            }
            if (!cardName) {
                e.preventDefault();
                alert('Please enter the name on the card');
                return;
            }
        }
    });
});
</script>
{% endblock %}
